<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - MyBlog</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <nav>
            <div class="logo">üìù MyBlog</div>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
            </ul>
        </nav>
    </header>

    <div class="auth-container">
        <div class="auth-box">
            <h2 id="formTitle">Login</h2>
            <p id="formSubtitle">Welcome back! Please login to your account.</p>

            <div id="errorMessage" class="error-message" style="display: none;"></div>
            <div id="successMessage" class="success-message" style="display: none;"></div>

            <!-- Login Form -->
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" required>
                </div>

                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required>
                </div>

                <button type="submit" class="btn-primary">Login</button>
            </form>

            <!-- Register Form -->
            <form id="registerForm" style="display: none;">
                <div class="form-group">
                    <label for="registerName">Name</label>
                    <input type="text" id="registerName" required>
                </div>

                <div class="form-group">
                    <label for="registerEmail">Email</label>
                    <input type="email" id="registerEmail" required>
                </div>

                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" required minlength="6">
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" required>
                </div>

                <button type="submit" class="btn-primary">Register</button>
            </form>

            <p class="toggle-form">
                <span id="toggleText">Don't have an account?</span>
                <a href="#" id="toggleLink">Register here</a>
            </p>
            <div style="margin-top:1.5rem; text-align:center;">
                <button id="demoLoginBtn" type="button" class="btn-secondary" style="width:100%;">Demo Login (Dev)</button>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const toggleLink = document.getElementById('toggleLink');
        const formTitle = document.getElementById('formTitle');
        const formSubtitle = document.getElementById('formSubtitle');
        const toggleText = document.getElementById('toggleText');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');

        let isLoginMode = true;

        // Toggle between login and register
        toggleLink.addEventListener('click', (e) => {
            e.preventDefault();
            isLoginMode = !isLoginMode;

            if (isLoginMode) {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                formTitle.textContent = 'Login';
                formSubtitle.textContent = 'Welcome back! Please login to your account.';
                toggleText.textContent = "Don't have an account?";
                toggleLink.textContent = 'Register here';
            } else {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                formTitle.textContent = 'Register';
                formSubtitle.textContent = 'Create a new account to start blogging.';
                toggleText.textContent = 'Already have an account?';
                toggleLink.textContent = 'Login here';
            }

            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        });

        // Login handler
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_URL}/users/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (data.success) {
                    setAuth(data.token, data.user);
                    showSuccess('Login successful! Redirecting...');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('Login failed. Please try again.');
            }
        });

        // Register handler
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (password !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/users/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, email, password })
                });

                const data = await response.json();

                if (data.success) {
                    setAuth(data.token, data.user);
                    showSuccess('Registration successful! Redirecting...');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('Registration failed. Please try again.');
            }
        });

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }

        // Demo login button (development convenience)
        const demoBtn = document.getElementById('demoLoginBtn');
        if (demoBtn) {
            demoBtn.addEventListener('click', async () => {
                errorMessage.style.display = 'none';
                successMessage.style.display = 'none';
                demoBtn.disabled = true;
                demoBtn.textContent = 'Logging in...';
                try {
                    const resp = await fetch(`${API_URL}/users/dev-login`, { method: 'POST' });
                    const data = await resp.json();
                    if (data.success) {
                        setAuth(data.token, data.user);
                        showSuccess('Demo login successful! Redirecting...');
                        setTimeout(() => window.location.href = 'index.html', 900);
                    } else {
                        showError(data.message || 'Demo login failed');
                    }
                } catch (e) {
                    showError('Demo login error');
                } finally {
                    demoBtn.disabled = false;
                    demoBtn.textContent = 'Demo Login (Dev)';
                }
            });
        }
    </script>
</body>
</html>